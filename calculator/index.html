<html>

  <head>

    <title>Calculator</title>

    <link href="https://assets.parasut.com/production/assets/parasut-b08bdcea77425c14a437f6f3db2c16bc.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json" />

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>

    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <style type="text/css">
      body {
        padding: 10vh 10vw;
      }
      .calculator-overlay {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        background: #eee;
      }
      .calculator-overlay-hidden {
        display: none !important;
      }
      .calculator-overlay span {
        font-size: 24px;
        font-weight: bold;
        display: block;
        width: 350px;
        line-height: 30px;
        position: absolute;
        top: 50%;
        left: 50%;
        margin-top: -15px;
        margin-left: -175px;
        text-align: center;
      }
    </style>

    <script type="text/javascript">
      window.onload = function() {
        Calculator.initAction();
      };

      var Calculator = (function(){
        var self = {},
            selectableOptions = ['gross', 'net', 'collected'],
            darkClass = 'c-bg1-darkest',
            whiteClass = 'c-bg-white1',
            calculationMethod = 'gross'; // initial calculation method, others are net & collected

        var helpTexts = {
          'gross'     : "Stopaj Tutarı ve KDV Tutarı Brüt Tutar üzerinden hesaplanır. Brüt Tutar, Stopaj Oranı ve KDV oranını belirleyerek diğer tutarları hesaplayın.",
          'net'       : "Net Tutar, KDV'yi ödedikten sonra elinizde kalacak olan tutardır. Net Tutar, Stopaj Oranı ve KDV Oranını belirleyerek diğer tutarları hesaplayabilirsiniz.",
          'collected' : "Tahsil Edilecek Tutar müşterinizin size ödeyeceği, KDV'yi de içeren tutardır. Tahsil Edilecek Tutar, Stopaj Oranı ve KDV Oranını belirleyerek diğer tutarları hesaplayın."
        }

        // handle tab select
        function makeSelected(buttonID, isSelected) {
          var element = $('#'+buttonID);
          // var editableField = $('#'+buttonID+'_amount');
          if(isSelected) {
            calculationMethod = buttonID;
            updateHelpText(buttonID);
            element.removeClass(darkClass);
            makeEditable(buttonID);
            calculate();
          } else {
            element.addClass(darkClass);
            makeDisabled(buttonID);
          }
        }

        function makeEditable(field) {
          var editableField = $('#'+field+'_amount');
          editableField.removeProp('disabled');
          editableField.removeClass(whiteClass);
        }

        function makeDisabled(field) {
          var editableField = $('#'+field+'_amount');
          editableField.prop('disabled', 'disabled');
          editableField.addClass(whiteClass);
        }

        function updateHelpText(button) {
          $('#help_text').text(helpTexts[button]);
        }

        function calculate() {
          switch(calculationMethod) {
            case 'gross':
              calculateFromGross();
              break;
            case 'net':
              calculateFromNet();
              break;
            case 'collected':
              calculateFromCollected();
              break;
          }
        }

        function calculateFromGross() {
          var gross_amount = parseAmount($('#gross_amount').val()),
              witholding_percentage = percantageWithoutSign($('#witholding_percentage').val()),
              tax_percentage = percantageWithoutSign($('#tax_percentage').val()),
              witholding_amount = 0,
              net_amount = 0,
              tax_amount = 0,
              collected_amount = 0;

          witholding_amount = gross_amount * witholding_percentage;
          net_amount        = gross_amount - witholding_amount;
          tax_amount        = gross_amount * tax_percentage;
          collected_amount  = net_amount + tax_amount;

          updateField('witholding_amount', witholding_amount);
          updateField('net_amount', net_amount);
          updateField('tax_amount', tax_amount);
          updateField('collected_amount', collected_amount);
        }

        function calculateFromNet () {
          var net_amount = parseAmount($('#net_amount').val()),
              witholding_percentage = percantageWithoutSign($('#witholding_percentage').val()),
              tax_percentage = percantageWithoutSign($('#tax_percentage').val()),
              witholding_amount = 0,
              gross_amount = 0,
              tax_amount = 0,
              collected_amount = 0;

          gross_amount      = net_amount / (1 - witholding_percentage);
          witholding_amount = gross_amount * witholding_percentage;
          tax_amount        = gross_amount * tax_percentage;
          collected_amount  = net_amount + tax_amount;

          updateField('witholding_amount', witholding_amount);
          updateField('gross_amount', gross_amount);
          updateField('tax_amount', tax_amount);
          updateField('collected_amount', collected_amount);
        }

        function calculateFromCollected () {
          var collected_amount = parseAmount($('#collected_amount').val()),
              witholding_percentage = percantageWithoutSign($('#witholding_percentage').val()),
              tax_percentage = percantageWithoutSign($('#tax_percentage').val()),
              witholding_amount = 0,
              gross_amount = 0,
              tax_amount = 0,
              net_amount = 0;

          gross_amount      = collected_amount / (1 - witholding_percentage + tax_percentage);
          witholding_amount = gross_amount * witholding_percentage;
          tax_amount        = gross_amount * tax_percentage;
          net_amount        = gross_amount - witholding_amount;

          updateField('witholding_amount', witholding_amount);
          updateField('gross_amount', gross_amount);
          updateField('tax_amount', tax_amount);
          updateField('net_amount', net_amount);
        }

        function updateField (elementID, value) {
          val = formatCurrency(value);
          if(val === 'NaN'){ val = '0,00' };
          $('#'+elementID).val(val);
        }

        function formatCurrency(value) {
          return applyCurrencyRegex(convertTwoDecimal(value));
        }

        function applyCurrencyRegex (value) {
          return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function convertTwoDecimal (value) {
          return parseFloat(value).toFixed(2).replace(/\./g, ',');
        }

        function parseAmount (value) {
          return parseFloat(value.replace(/\./g, '').replace(/,/g, '.'));
        }

        function percantageWithoutSign (percantageText) {
          return parseInt(percantageText)/100;
        }

        function validateInput(value){
          return applyCurrencyRegex(value.replace(/[^0-9\,]/g, '').replace(/(,[0-9]{0,2})([0-9,]*)/, "$1"));
        }

        self.clickOption = function(clickedButton) {
          for (var i in selectableOptions) {
            var selected = false;
            if(selectableOptions[i] === clickedButton) {
              selected = true;
            }
            makeSelected(selectableOptions[i], selected);
          }
        }

        self.setTabLinks = function () {
          var tabs = ['gross', 'net', 'collected'];
          for (var i in tabs) {
            var fieldName = '#'+ tabs[i];
            $(fieldName).on('click', function () {
              Calculator.clickOption($(this).prop('id'));
            })
          }
        }

        self.setObservedFields = function () {
          var observedFields = ['#gross_amount', '#net_amount', '#collected_amount', '#witholding_percentage', '#tax_percentage'];
          for (var i in observedFields) {
            $(observedFields[i]).on("propertychange change keyup paste input", function(){
              calculate();
            });
          }
        }

        makeCalculatorVisible = function () {
          $('.calculator-overlay').addClass('calculator-overlay-hidden');
        }

        self.initAction = function () {
          self.setTabLinks();
          self.setObservedFields();
          // add auto select value feature
          $('#gross_amount, #net_amount, #collected_amount').on("click", function () {
            $(this).select();
          }).on("propertychange change keyup paste input", function(){
            $(this).val(validateInput($(this).val()));
          });
          makeCalculatorVisible();
        }

        return self;
      })();
    </script>
  </head>

  <body>

    <div class="form u-clearfix u-mt1 calculator" style="position:relative">
      <div class="form-content">

        <div class="u-clearfix u-relative u-pv1 u-borderBottom">
          <button id="gross" class="button button-outline button-joinRight" style="width:27.5%;">BRÜTTEN HESAPLA</button><button id="net" class="button button-outline button-joinBoth c-bg1-darkest" style="width:27.5%;">NETTEN HESAPLA</button><button id="collected" class="button button-outline button-joinLeft c-bg1-darkest" style="width:45%;">TAHSİL EDİLECEKTEN HESAPLA</button>
          <p class="u-mt1 u-mb0 u-relative">
            <i class="fa fa-info-circle u-width1 c-text-on-light3 u-pullLeft u-positionTL"></i><div id="help_text" class="u-pullLeft u-ml15">Brüt tutarı, stopaj oranını ve KDV oranını girerek hesaplayabilirsiniz. Stopaj tutarı ve KDV tutarı brüt tutar üzerinden hesaplanır.</div>
          </p>
        </div>

        <div class="u-clearfix u-relative u-pt1 u-borderTop">
          <div class="u-pullLeft l-col6 u-pa0 u-pt025">
            <h5 class="c-text-on-light3 u-pullLeft u-width1 u-mr05"><img src="http://parasut-mailing.s3.amazonaws.com/spacer.gif" style="width:0px; height:0px;" width="0" height="0"></h5>
            <label for="gross_amount"><h4>BRÜT TUTAR</h4></label>
          </div>
          <div class="u-pullLeft l-col10 u-pa0">
            <input id="gross_amount" class="field field-number u-textRight u-pr125" type="text" value="1.000,00" name="">
            <i class="fa fa-try u-positionTR u-mt1 u-mr05 u-lineHeight30 c-text-on-light2"></i>
          </div>
        </div>

        <div class="u-clearfix u-relative u-borderBottom">
          <div class="u-pullLeft l-col6 u-pa0 u-pt025">
            <h5 class="c-text-on-light3 u-pullLeft u-width1 u-mr05"><i class="fa fa-minus"></i></h5>
            <label for="witholding_amount"><h4>GELİR VERGİSİ STOPAJI</h4></label>
          </div>
          <div class="l-col4 u-pa0 u-pr1">
            <div class="select-group u-relative proxy-dropdown year-select">
              <div class="field field-select u-textRight u-pr15">%20</div>
              <select id="witholding_percentage" name="" class="u-fullWidth">
                <option value="20" selected="selected">%20</option>
                <option value="0">%0</option>
              </select>
            </div>
          </div>
          <div class="u-pullLeft l-col6 u-pa0">
            <input id="witholding_amount" class="field field-number c-bgLighter u-textRight u-pr125 c-bg-white1" type="text" value="200,00" name="" disabled="disabled">
            <i class="fa fa-try u-positionTR u-mr05 u-lineHeight30 c-text-on-light2"></i>
          </div>
        </div>

        <div class="u-clearfix u-relative u-borderTop u-pt1">
          <div class="u-pullLeft l-col6 u-pa0 u-pt025">
            <h5 class="c-text-on-light3 u-pullLeft u-width1 u-mr05">
              <span style="font-size:24px; font-weight:bold;">=</span>
            </h5>
            <label for="net_amount"><h4>NET TUTAR</h4></label>
          </div>
          <div class="u-pullLeft l-col10 u-pa0">
            <input id="net_amount" class="field field-number u-textRight u-pr125 c-bg-white1" type="text" value="800,00" name="" disabled="disabled">
            <i class="fa fa-try u-positionTR u-mt1 u-mr05 u-lineHeight30 c-text-on-light2"></i>
          </div>
        </div>

        <div class="u-clearfix u-relative u-borderBottom">
          <div class="u-pullLeft l-col6 u-pa0 u-pt025">
            <h5 class="c-text-on-light3 u-pullLeft u-width1 u-mr05"><i class="fa fa-plus"></i></h5>
            <label for="tax_amount"><h4>KDV</h4></label>
          </div>
          <div class="l-col4 u-pa0 u-pr1">
            <div class="select-group u-relative proxy-dropdown year-select">
              <div class="field field-select u-textRight u-pr15">%18</div>
              <select id="tax_percentage" name="" class="u-fullWidth">
                <option value="18" selected="selected">%18</option>
                <option value="8">%8</option>
                <option value="1">%1</option>
              </select>
            </div>
          </div>
          <div class="u-pullLeft l-col6 u-pa0">
            <input id="tax_amount" class="field field-number u-textRight u-pr125 c-bg-white1" type="text" value="180,00" name="" disabled="disabled">
            <i class="fa fa-try u-positionTR u-mr05 u-lineHeight30 c-text-on-light2"></i>
          </div>
        </div>

        <div class="u-clearfix u-relative u-borderTop u-pt1">
          <div class="u-pullLeft l-col6 u-pa0 u-pt025">
            <h5 class="c-text-on-light3 u-pullLeft u-width1 u-mr05"><span style="font-size:24px; font-weight:bold;">=</span></h5>
            <label for="collected_amount"><h4>TAHSİL EDİLECEK TUTAR</h4></label>
          </div>
          <div class="u-pullLeft l-col10 u-pa0">
            <input id="collected_amount" class="field field-number u-textRight u-pr125 c-bg-white1" type="text" value="980,00" name="" disabled="disabled">
            <i class="fa fa-try u-positionTR u-mt1 u-mr05 u-lineHeight30 c-text-on-light2"></i>
          </div>
        </div>

      </div>
      <div class="calculator-overlay"><span>Hesap makinesi yükleniyor...</span></div>
    </div>

    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('serviceworker.js');
      }
    </script>

  </body>

</html>